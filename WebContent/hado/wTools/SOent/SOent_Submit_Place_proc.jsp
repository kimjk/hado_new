<%@ page session="true" language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%><%/*** 프로젝트명	: 하도급거래 서면실태조사 지원을 위한 개발용역 사업* 프로그램명	: SOent_Submit_Place_proc.jsp* 프로그램설명	: 수급사업자 > 제출현황 > 담당사무소별 제출현황* 프로그램버전	: 3.1.1* 최초작성일자	: 2014년 09월 24일* 작 성 이 력       :*=========================================================*	작성일자		작성자명				내용*=========================================================*	2014-09-24	정광식       최초작성*   2015-07-22   정광식		조사제외대상 처리방법 변경 적용 (SP_FLD_03 필드에 제외사유)*	2016-01-07	이용광		DB변경으로 인한 인코딩 변경*/%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="ftc.db.ConnectionResource2"%><%@ page import="java.text.DecimalFormat"%><%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%@ include file="/hado/wTools/inc/WB_I_chkMngSession.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String stt = StringUtil.checkNull(request.getParameter("tt")).trim();	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;	String sSQLs = "";	Long[][] table_sum = new Long[38][8];	Long[] e_total = new Long[8];	String[] oentgb = new String[38];	int nLoop = 0;//	int sStartYear = 2000;	int sStartYear = 2011;	java.util.Calendar cal = java.util.Calendar.getInstance();	DecimalFormat formater = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0.00");/*-----------------------------------------------------------------------------------------------------*//*=================================== Record Selection Processing =====================================*/	String tmpYear = StringUtil.checkNull(request.getParameter("cyear")).trim();	if( !tmpYear.equals("") ) {		session.setAttribute("cyear", tmpYear);	} else {		session.setAttribute("cyear", st_Current_Year);	}	int currentYear = st_Current_Year_n;	currentYear = Integer.parseInt(session.getAttribute("cyear")+"");	String currentOent = currentYear>=2012 ? "HADO_TB_Oent_"+currentYear : "HADO_TB_Oent";	// 초기화	for(int i=1;i<8;i++) {		e_total[i] = new Long(0);	}	try {		resource = new ConnectionResource();		conn = resource.getConnection();		if( !stt.equals("start") ) {			sSQLs+="SELECT A.Center_Name,A.typ_Cnt,A.d1,A.d2,A.d3,A.d4,A.d5,B.OentCNT \n";			sSQLs+="FROM ( \n";			sSQLs+="	SELECT Center_Name, COUNT(*) typ_cnt, \n";			if( currentYear >= 2015 ) {					/* 2015년도 조사제외대상 사유 기록시작 : SP_FLD_03				* SP_FLD_03 = = '1' : 가. 귀사가 "하도급법상의 수급사업자" 요건에 해당되지 않는 경우				* SP_FLD_03 = = '2' : 나. 하도급거래가 아닌 경우				* SP_FLD_03 = = '3' : 다. 귀사가 하도급을 주기만 하는 경우				* SP_FLD_03 = = '4' : 라. 하도급을 주지도 받지도 않는 경우(하도급거래 없음)				*/				sSQLs+="		SUM(CASE WHEN Addr_Status='1' THEN 1 ELSE 0 END) d1, \n";	// 소재불명				sSQLs+="		SUM(CASE WHEN Addr_Status='2' OR sp_fld_03='2' OR sp_fld_03='3' OR sp_fld_03='4' THEN 1 ELSE 0 END) d2, \n"; // 하도급거래없음				sSQLs+="		SUM(CASE WHEN Addr_Status='3' OR sp_fld_03='1' THEN 1 ELSE 0 END) d3, \n"; // 요건안됨 (대기업 등)				sSQLs+="		SUM(CASE WHEN Addr_Status='4' THEN 1 ELSE 0 END) d4, \n"; // 중복업체 추가 - KS Jung - 20110923				sSQLs+="		SUM(CASE WHEN Sent_Status='1' THEN \n";				sSQLs+="			CASE WHEN Addr_Status='1' OR Addr_Status='2' OR Addr_Status='3' OR Addr_Status='4' THEN 0 ELSE 1 END \n";				sSQLs+="		ELSE 0 END) d5 \n";			} else {				sSQLs+="		SUM(CASE WHEN Addr_Status='1' THEN 1 ELSE 0 END) d1, \n";	// 소재불명				sSQLs+="		SUM(CASE WHEN Addr_Status='2' THEN 1 ELSE 0 END) d2, \n"; // 하도급거래없음				sSQLs+="		SUM(CASE WHEN Addr_Status='3' THEN 1 ELSE 0 END) d3, \n"; // 요건안됨 (대기업 등)				sSQLs+="		SUM(CASE WHEN Addr_Status='4' THEN 1 ELSE 0 END) d4, \n"; // 중복업체 추가 - KS Jung - 20110923				sSQLs+="		SUM(CASE WHEN Sent_Status='1' THEN \n";				sSQLs+="			CASE WHEN Addr_Status='1' OR Addr_Status='2' OR Addr_Status='3' OR Addr_Status='4' THEN 0 ELSE 1 END \n";				sSQLs+="		ELSE 0 END) d5 \n";			}			sSQLs+="	FROM ( \n";			sSQLs+="		SELECT * FROM HADO_VT_SOent_"+currentYear+" \n";			sSQLs+="		WHERE Sel_GB='1' \n";			sSQLs+="			AND SUBSTR(Mng_No,-7)<>'1234567' \n";			if( currentYear >=2014) {				sSQLs+="		AND LENGTH(Mng_No) > 6 \n";			} else {				sSQLs+="		AND LENGTH(Mng_No) > 4 \n";			}			sSQLs+="	) \n";			sSQLs+="	GROUP BY Center_Name \n";			sSQLs+=") A \n";			sSQLs+="LEFT JOIN ( \n";			sSQLs+="	SELECT Center_Name, \n";			sSQLs+="		SUM(CASE WHEN Oent_Status='1' THEN \n";			if(currentYear == 2020) {				sSQLs+="			CASE WHEN Comp_Status='1' THEN CASE WHEN (SELECT COUNT(*) FROM HADO_TB_OENT_ANSWER_2020 WHERE MNG_NO = CCC.MNG_NO AND CURRENT_YEAR = CCC.CURRENT_YEAR AND OENT_GB = CCC.OENT_GB AND OENT_Q_CD = 5 AND OENT_Q_GB = 1 AND (A = 1 OR B = 1)) = 1 THEN 1 ELSE 0 END ELSE 0 END \n";			}			else {				sSQLs+="			CASE WHEN Comp_Status='1' THEN CASE WHEN Subcon_Type < '3' THEN 1 ELSE 0 END ELSE 0 END \n";			}			sSQLs+="		ELSE 0 END) OentCNT \n";			sSQLs+="	FROM ( \n";			sSQLs+="		SELECT C.*,D.Center_Name \n";			sSQLs+="		FROM ( \n";			sSQLs+="			SELECT * FROM "+currentOent+" \n";			sSQLs+="				WHERE Current_Year='"+currentYear+"' \n";			if( currentYear > 2006 ) {				sSQLs+="					AND Oent_GB<>'2' \n";			}			sSQLs+="		) C \n";			if( currentYear >=2014) {				sSQLs+="		LEFT JOIN HADO_VT_Dept_History_"+currentYear+" D \n";			} else {				sSQLs+="		LEFT JOIN HADO_VT_Dept_History D \n";			}			sSQLs+="		ON C.Mng_No=D.Mng_No \n";			sSQLs+="			AND C.Current_Year=D.Current_Year \n";			sSQLs+="			AND C.Oent_GB=D.Oent_GB \n";			sSQLs+="	) CCC \n";			sSQLs+="	GROUP BY Center_Name \n";			sSQLs+=") B \n";			sSQLs+="ON A.Center_Name=B.Center_Name \n";			sSQLs+="ORDER BY typ_CNT DESC";			//System.out.println(sSQLs);			pstmt = conn.prepareStatement(sSQLs);			rs = pstmt.executeQuery();			int n = 1;			while( rs.next() ) {				oentgb[n] = rs.getString("Center_Name");				table_sum[n][1] = rs.getLong("typ_cnt");				table_sum[n][2] = rs.getLong("d1");				table_sum[n][3] = rs.getLong("d2");				table_sum[n][4] = rs.getLong("d3");				table_sum[n][5] = rs.getLong("d4");				table_sum[n][6] = rs.getLong("d5");				table_sum[n][7] = rs.getLong("OentCnt");				e_total[1] = e_total[1] + table_sum[n][1];				e_total[2] = e_total[2] + table_sum[n][2];				e_total[3] = e_total[3] + table_sum[n][3];				e_total[4] = e_total[4] + table_sum[n][4];				e_total[5] = e_total[5] + table_sum[n][5];				e_total[6] = e_total[6] + table_sum[n][6];				e_total[7] = e_total[7] + table_sum[n][7];				n++;			}			nLoop = n - 1;			rs.close();		}	}	catch(Exception e){		e.printStackTrace();	}	finally {		if ( rs != null ) try { rs.close(); } catch(Exception e) { }		if ( pstmt != null ) try { pstmt.close(); } catch(Exception e) { }		if ( conn != null ) try { conn.close(); } catch(Exception e) { }		if ( resource != null ) resource.release();	}/*=====================================================================================================*/%><meta charset="utf-8"><script type="text/javascript">//<![CDATA[content = "";content+="<table id='divButton'>";content+="	<tr>";content+="		<td><%=cal.get(Calendar.YEAR)%>년<%=cal.get(Calendar.MONTH)+1%>월<%=cal.get(Calendar.DATE)%>일(현재)</td>";content+="	</tr>";content+="</table>";content+="<table class='resultTable'>";content+="	<tr>";content+="		<th rowspan=3 height=240px width=60px>사무소별</th>";content+="		<th colspan=7>조사대상 수급사업자</th>";content+="		<th rowspan=3>정상제출<br>(D)</th>";content+="		<th rowspan=3>총제출<br>(E=B+D)</th>";content+="		<th rowspan=3>미제출<br>(F=C-D)</th>";content+="		<th rowspan=3>D/A</th>";content+="		<th rowspan=3>D/C</th>";content+="		<th rowspan=3>E/A</th>";content+="		<th rowspan=3>원사업자수<br>(정상영업 및 하도급거래)</th>";content+="		<th rowspan=3>원사업자에 대한 수급사업자 조사표 제출비율</th>";content+="	</tr>";content+="	<tr>";content+="		<th rowspan=2>총대상업체(A)</th>";content+="		<th colspan=5>반송업체(B)</th>";content+="		<th rowspan=2>대상업체(C=A-B)</th>";content+="	</tr>";content+="	<tr>";content+="		<th>소재불명</th>";content+="		<th>하도급거래없음</th>";content+="		<th>요건안됨(대기업등)</th>";content+="		<th>중복업체</th>";content+="		<th>계</th>";content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th>전체</th>";content+="		<td><%=e_total[1]%></td>";content+="		<td><%=e_total[2]%></td>";content+="		<td><%=e_total[3]%></td>";content+="		<td><%=e_total[4]%></td>";content+="		<td><%=e_total[5]%></td>";content+="		<td><%=e_total[2]+e_total[3]+e_total[4]+e_total[5]%></td>";content+="		<td><%=e_total[1]-(e_total[2]+e_total[3]+e_total[4]+e_total[5])%></td>";content+="		<td><%=e_total[6]%></td>";content+="		<td><%=e_total[6]+(e_total[2]+e_total[3]+e_total[4]+e_total[5])%></td>";content+="		<td><%=(e_total[1]-(e_total[2]+e_total[3]+e_total[4]+e_total[5]))-e_total[6]%></td>";content+="		<td>";		<%if(e_total[6]!=null) { %>content+="			<%=formater.format(((float)e_total[6]/(float)e_total[1])*100F)%>";		<%} else { %>content+="			0";		<%}%>content+="			%";content+="		</td>";content+="		<td>";		<%if(e_total[6]!=null) { %>content+="			<%=formater.format(((float)e_total[6]/((float)e_total[1]-((float)e_total[2]+(float)e_total[3]+(float)e_total[4]+(float)e_total[5])))*100F)%>";		<%} else { %>content+="			0";		<%}%>content+="			%";content+="		</td>";content+="		<td><%=formater.format((((float)e_total[6]+((float)e_total[2]+(float)e_total[3]+(float)e_total[4]+(float)e_total[5]))/(float)e_total[1])*100F)%>%</td>";content+="		<td><%=e_total[7]%></td>";content+="		<td>";		<%if(e_total[6]!=null) {%>content+="			<%=formater.format(  (float)e_total[6] / ((float)e_total[7])  )%>";		<%} else {%>content+="			0";		<%}%>content+="		</td>";content+="	</tr>";<%for(int y=1; y <= nLoop; y++) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th><%=oentgb[y]%></th>";content+="		<td><%=table_sum[y][1]%></td>";content+="		<td><%=table_sum[y][2]%></td>";content+="		<td><%=table_sum[y][3]%></td>";content+="		<td><%=table_sum[y][4]%></td>";content+="		<td><%=table_sum[y][5]%></td>";content+="		<td><%=table_sum[y][2]+table_sum[y][3]+table_sum[y][4]+table_sum[y][5]%></td>";content+="		<td><%=table_sum[y][1]-(table_sum[y][2]+table_sum[y][3]+table_sum[y][4]+table_sum[y][5])%></td>";content+="		<td><%=table_sum[y][6]%></td>";content+="		<td><%=table_sum[y][6]+(table_sum[y][2]+table_sum[y][3]+table_sum[y][4]+table_sum[y][5])%></td>";content+="		<td><%=(table_sum[y][1]-(table_sum[y][2]+table_sum[y][3]+table_sum[y][4]+table_sum[y][5]))-table_sum[y][6]%></td>";content+="		<td>";		<%if(table_sum[y][6]!=null) { %>content+="			<%=formater.format((float)table_sum[y][6]/(float)table_sum[y][1]*100F)%>";		<%} else { %>content+="			0";		<%}%>content+="		%";content+="		</td>";content+="		<td>";		<%if(table_sum[y][6]!=null) { %>content+="			<%=formater.format((float)table_sum[y][6]/((float)table_sum[y][1]-((float)table_sum[y][2]+(float)table_sum[y][3]+(float)table_sum[y][4]+(float)table_sum[y][5]))*100F)%>";		<%} else { %>content+="			0";		<%}%>content+="		%";content+="		</td>";content+="		<td><%=formater.format( ( ( (float)table_sum[y][6]+(float)table_sum[y][2]+(float)table_sum[y][3]+(float)table_sum[y][4]+(float)table_sum[y][5] ) / (float)table_sum[y][1] )*100F )%>%</td>";content+="		<td><%=table_sum[y][7]%></td>";content+="		<td>";		<%if(table_sum[y][6]!=null) { %>content+="			<%=formater.format( (float)table_sum[y][6] / (float)table_sum[y][7] )%>"; 		<%} else { %>content+="			0";		<%}%>content+="		</td>";content+="	</tr>";<%}%>content+="	</table>";top.document.getElementById("divResult").innerHTML = content;top.setNowProcessFalse();//]]</script><%@ include file="/hado/wTools/inc/WB_I_Function.jsp"%>