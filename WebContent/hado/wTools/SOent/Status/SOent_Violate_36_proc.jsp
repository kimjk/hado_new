<%@ page session="true" language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%><%/*** 프로젝트명	 : 하도급거래 서면실태조사 지원을 위한 개발용역 사업								   * 프로그램명	 : SOent_Violate_36_proc.jsp																			   * 프로그램설명	: 수급사업자 > 조사결과분석 > 위반행위수 현황(원사업자별 수급사업자 응답)    * 프로그램버전	: 1.0.1																				                        * 최초작성일자	: 2015년 09월 01일													                            * 작 성 이 력       :                                                                                                                           *=========================================================*	작성일자		작성자명				내용*=========================================================*	2015-09-01	강슬기        페이지 최신화(주석, 불필요한 코드 제거, 오래된 코드 수정) *   2015-11-02   정광식	     위반혐의 항목 세팅 오류 수정 (2015년조사시 미반영 위반혐의가 포함됨)*   2015-09-15   강슬기        2015년도 조사제외대상 조건 추가*   2016-01-07   이용광        DB변경으로 인한 인코딩 변경*/%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="java.text.DecimalFormat"%><%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%@ include file="/hado/wTools/inc/WB_I_chkMngSession.jsp"%><%@ include file="/hado/wTools/inc/WB_I_Function.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String tt = request.getParameter("tt")==null? "":request.getParameter("tt").trim();	String comm = request.getParameter("comm")==null? "":request.getParameter("comm").trim();	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;	String sSQLs = "";	String[][] arrData = new String[50][17];	float[] arrSum = new float[16];	int nLoop = 1;	float tmpSum = 0F;	int sStartYear = 2000;	java.util.Calendar cal = java.util.Calendar.getInstance();	DecimalFormat formater = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0.0");	DecimalFormat formater2 = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0");/*-----------------------------------------------------------------------------------------------------*//*=================================== Record Selection Processing =====================================*/		String tmpYear = request.getParameter("cyear")==null? "":request.getParameter("cyear").trim();	if( !tmpYear.equals("") ) {		session.setAttribute("cyear", tmpYear);	} else {		session.setAttribute("cyear", st_Current_Year);	}	// 합계배열 초기화	for(int i=1; i <=15; i++) { 		arrSum[i] = 0F; 	}	if( tt.equals("start") ) {		session.setAttribute("wgb","");		session.setAttribute("cstatus","");	}	if( comm.equals("search") ) {		session.setAttribute("wgb", request.getParameter("wgb")==null? "":request.getParameter("wgb").trim());		session.setAttribute("cstatus", StringUtil.checkNull(request.getParameter("cstatus")).trim());	}	int currentYear = st_Current_Year_n;	currentYear = Integer.parseInt(session.getAttribute("cyear")+"");	int endCurrentYear = st_Current_Year_n;	// view table name	String currentOent = currentYear>=2012 ? "HADO_TB_Oent_"+tmpYear : "HADO_TB_Oent";	if( !tt.equals("start") ) {			/* 2015-11-02 / 2015년도 미반영 위반혐의 내역 오류 수정 - 정광식 */		String sTbSurveyNm = "HADO_TB_SOent_Survey_Result";		String sFldPlusStr = "(d1+d2+d3+d4+d5+d6+d7+d8+d9+d10+d11+d12+d13+d14+d15+d16+a1+a2+a3+a4+a5+a6+a7+a8+a9+a10+a11+a12+a13+a14+a15+a16+a17+a18+a19+a20)";		if( currentYear==2015 ) {			/* 처리결과 최적화를 위하여 2015년부터는 별도의 테이블로 변경시작함 (차후년도 독립테이블 구성 필요)				2015년도 결과는 본 프로세스에만 적용함. (타 통계표에는 2016년부터 적용 예정)			*/			sTbSurveyNm = "HADO_TB_SOent_Survey_Rst_2015";			String sTmpGb = session.getAttribute("wgb").toString();			if( sTmpGb.equals("2") ) { // 건설				sTmpGb = "(d1+d2+d3+d4+d5+d6+d7+a1+a2+a3+a4+a5+a6+a7+a8+a9+a10+a11+a12+a13+a14+a15+a16+a17)";			} else {	// 제조,용역				sTmpGb = "(d1+d2+d3+d4+d5+d6+d7+a1+a2+a3+a4+a5+a6+a7+a8+a9+a10+a11+a12+a13+a14+a15+a16+a17)";			}		} 		sSQLs="SELECT d.Common_CD||'('||Common_NM||')' typecd,c.* FROM ( \n";		sSQLs+="  SELECT Oent_Type,NVL(COUNT(*),0) Oent_Cnt, \n";		sSQLs+="  SUM(CASE Sent_Status WHEN '1' THEN 1 ELSE 0 END) Submit_Cnt, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+">0 THEN 1 ELSE 0 END) Survey_Cnt, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=1 THEN 1 ELSE 0 END) Cnt1, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=2 THEN 1 ELSE 0 END) Cnt2, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=3 THEN 1 ELSE 0 END) Cnt3, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=4 THEN 1 ELSE 0 END) Cnt4, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=5 THEN 1 ELSE 0 END) Cnt5, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=6 THEN 1 ELSE 0 END) Cnt6, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=7 THEN 1 ELSE 0 END) Cnt7, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=8 THEN 1 ELSE 0 END) Cnt8, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=9 THEN 1 ELSE 0 END) Cnt9, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+"=10 THEN 1 ELSE 0 END) Cnt10, \n";		sSQLs+="  SUM(CASE WHEN "+sFldPlusStr+">10 THEN 1 ELSE 0 END) Cnt11 FROM ( \n";		sSQLs+="	SELECT Mng_No,Current_Year,Oent_GB,Oent_Type, \n";		sSQLs+="	CASE WHEN SUM(d1) > 0 THEN 1 ELSE 0 END d1, \n";		sSQLs+="	CASE WHEN SUM(d2) > 0 THEN 1 ELSE 0 END d2, \n";		sSQLs+="	CASE WHEN SUM(d3) > 0 THEN 1 ELSE 0 END d3, \n";		sSQLs+="	CASE WHEN SUM(d4) > 0 THEN 1 ELSE 0 END d4, \n";		sSQLs+="	CASE WHEN SUM(d5) > 0 THEN 1 ELSE 0 END d5, \n";		sSQLs+="	CASE WHEN SUM(d6) > 0 THEN 1 ELSE 0 END d6, \n";		sSQLs+="	CASE WHEN SUM(d7) > 0 THEN 1 ELSE 0 END d7, \n";		sSQLs+="	CASE WHEN SUM(d8) > 0 THEN 1 ELSE 0 END d8, \n";		sSQLs+="	CASE WHEN SUM(d9) > 0 THEN 1 ELSE 0 END d9, \n";		sSQLs+="	CASE WHEN SUM(d10) > 0 THEN 1 ELSE 0 END d10, \n";		sSQLs+="	CASE WHEN SUM(d11) > 0 THEN 1 ELSE 0 END d11, \n";		sSQLs+="	CASE WHEN SUM(d12) > 0 THEN 1 ELSE 0 END d12, \n";		sSQLs+="	CASE WHEN SUM(d13) > 0 THEN 1 ELSE 0 END d13, \n";		sSQLs+="	CASE WHEN SUM(d14) > 0 THEN 1 ELSE 0 END d14, \n";		sSQLs+="	CASE WHEN SUM(d15) > 0 THEN 1 ELSE 0 END d15, \n";		sSQLs+="	CASE WHEN SUM(d16) > 0 THEN 1 ELSE 0 END d16, \n";		sSQLs+="	CASE WHEN SUM(a1) > 0 THEN 1 ELSE 0 END a1, \n";		sSQLs+="	CASE WHEN SUM(a2) > 0 THEN 1 ELSE 0 END a2, \n";		sSQLs+="	CASE WHEN SUM(a3) > 0 THEN 1 ELSE 0 END a3, \n";		sSQLs+="	CASE WHEN SUM(a4) > 0 THEN 1 ELSE 0 END a4, \n";		sSQLs+="	CASE WHEN SUM(a5) > 0 THEN 1 ELSE 0 END a5, \n";		sSQLs+="	CASE WHEN SUM(a6) > 0 THEN 1 ELSE 0 END a6, \n";		sSQLs+="	CASE WHEN SUM(a7) > 0 THEN 1 ELSE 0 END a7, \n";		sSQLs+="	CASE WHEN SUM(a8) > 0 THEN 1 ELSE 0 END a8, \n";		sSQLs+="	CASE WHEN SUM(a9) > 0 THEN 1 ELSE 0 END a9, \n";		sSQLs+="	CASE WHEN SUM(a10) > 0 THEN 1 ELSE 0 END a10, \n";		sSQLs+="	CASE WHEN SUM(a11) > 0 THEN 1 ELSE 0 END a11, \n";		sSQLs+="	CASE WHEN SUM(a12) > 0 THEN 1 ELSE 0 END a12, \n";		sSQLs+="	CASE WHEN SUM(a13) > 0 THEN 1 ELSE 0 END a13, \n";		sSQLs+="	CASE WHEN SUM(a14) > 0 THEN 1 ELSE 0 END a14, \n";		sSQLs+="	CASE WHEN SUM(a15) > 0 THEN 1 ELSE 0 END a15, \n";		sSQLs+="	CASE WHEN SUM(a16) > 0 THEN 1 ELSE 0 END a16, \n";		sSQLs+="	CASE WHEN SUM(a17) > 0 THEN 1 ELSE 0 END a17, \n";		sSQLs+="	CASE WHEN SUM(a18) > 0 THEN 1 ELSE 0 END a18, \n";		sSQLs+="	CASE WHEN SUM(a19) > 0 THEN 1 ELSE 0 END a19, \n";		sSQLs+="	CASE WHEN SUM(a20) > 0 THEN 1 ELSE 0 END a20, \n";		sSQLs+="	CASE WHEN SUM(TO_NUMBER(NVL(Sent_Status,0))) > 0 THEN '1' ELSE NULL END Sent_Status FROM ( \n";		sSQLs+="	  SELECT a.Mng_No,a.Current_Year,a.Oent_GB,a.Oent_Type,a.Sent_Status,a.Addr_Status, \n";		sSQLs+="	  b.d1,b.d2,b.d3,b.d4,b.d5,b.d6,b.d7,b.d8,b.d9,b.d10,b.d11,b.d12,b.d13,b.d14,b.d15,b.d16, \n";		sSQLs+="	  b.a1,b.a2,b.a3,b.a4,b.a5,b.a6,b.a7,b.a8,b.a9,b.a10,b.a11,b.a12,b.a13,b.a14,b.a15,b.a16,b.a17,b.a18,b.a19,b.a20 FROM ( \n";		sSQLs+="		SELECT bb.Mng_No,aa.Child_Mng_No,bb.Oent_GB,bb.Current_Year,bb.Oent_Type,aa.Sent_Status,aa.Addr_Status FROM ( \n";		sSQLs+="		  SELECT * FROM "+currentOent+" WHERE Oent_GB='"+session.getAttribute("wgb")+"' \n";		sSQLs+="		  AND Current_Year='"+currentYear+"' AND Oent_Status='1' \n";		if(currentYear>=2014) {			sSQLs+="		  AND LENGTH(Mng_No)>6 \n";		} else {			sSQLs+="		  AND LENGTH(Mng_No)>4 \n";		}		sSQLs+="		  AND Comp_Status='1' AND Subcon_Type<='2' AND Addr_Status IS NULL \n";		/* 2015-09-15 / 강슬기 / 2015년도 조사제외대상 조건 추가 		if( currentYear>=2015 ) {			sSQLs+="		AND sp_fld_03 IS NULL \n";		}		*/		if( currentYear>=2015 ) {			sSQLs+="		AND sp_fld_03 IS NULL \n";		}		sSQLs+="		) bb LEFT JOIN ( \n";		sSQLs+="		  SELECT * FROM HADO_TB_Subcon_"+currentYear+" WHERE Sel_GB='1' \n";		sSQLs+="		  AND Oent_GB='"+session.getAttribute("wgb")+"' AND Current_Year='"+currentYear+"' AND Addr_Status IS NULL \n";		sSQLs+="		) aa ON aa.Mng_No=bb.Mng_No AND aa.Current_Year=bb.Current_Year AND aa.Oent_GB=bb.Oent_GB \n";		sSQLs+="	  ) a LEFT JOIN ( \n";		sSQLs+="		SELECT * FROM "+sTbSurveyNm+" \n";			if( session.getAttribute("cstatus").equals("1") ) {				sSQLs+="		WHERE Survey_Money_Total>0 \n";			} else if( session.getAttribute("cstatus").equals("2") ) {				sSQLs+="		WHERE Survey_Money_Total=0 AND Survey_Bi_Total>0 \n";			}		sSQLs+="	  ) b ON a.Child_Mng_No=b.Mng_No AND a.Oent_GB=b.Oent_GB AND a.Current_Year=b.Current_Year \n";		sSQLs+="	) VT_Table GROUP BY Mng_No,Current_Year,Oent_GB,Oent_Type \n";		sSQLs+="  ) VTT_Table GROUP BY Oent_Type \n";		sSQLs+=") c LEFT JOIN Common_CD d \n";		sSQLs+="ON UPPER(c.Oent_Type)=d.Common_CD AND d.ADDON_GB='" + session.getAttribute("wgb") + "' \n";		sSQLs+="ORDER BY c.Oent_Type \n";		try {			resource = new ConnectionResource();			conn = resource.getConnection();			pstmt = conn.prepareStatement(sSQLs);			rs = pstmt.executeQuery();			nLoop = 1;			while( rs.next() ) {				arrData[nLoop][1] = StringUtil.checkNull(rs.getString("typecd")).trim();				arrData[nLoop][2] = rs.getString("oent_cnt");				arrData[nLoop][3] = rs.getString("submit_cnt");				arrData[nLoop][4] = rs.getString("survey_cnt");				arrData[nLoop][5] = "" + (Integer.parseInt(arrData[nLoop][3]) - Integer.parseInt(arrData[nLoop][4]));				arrData[nLoop][6] = rs.getString("cnt1");				arrData[nLoop][7] = rs.getString("cnt2");				arrData[nLoop][8] = rs.getString("cnt3");				arrData[nLoop][9] = rs.getString("cnt4");				arrData[nLoop][10] = rs.getString("cnt5");				arrData[nLoop][11] = rs.getString("cnt6");				arrData[nLoop][12] = rs.getString("cnt7");				arrData[nLoop][13] = rs.getString("cnt8");				arrData[nLoop][14] = rs.getString("cnt9");				arrData[nLoop][15] = rs.getString("cnt10");				arrData[nLoop][16] = rs.getString("cnt11");				for(int x=1; x<=15; x++) {					arrSum[x] = arrSum[x] + Float.parseFloat(arrData[nLoop][x+1]);				}				nLoop++;			}			rs.close();			nLoop--;		} catch(Exception e) {			e.printStackTrace();		} finally {			if(rs!=null)		try{rs.close();}	catch(Exception e){}			if(pstmt!=null)		try{pstmt.close();}	catch(Exception e){}			if(conn!=null)		try{conn.close();}	catch(Exception e){}			if(resource!=null)	resource.release();		}	}%><meta charset="utf-8"><script type="text/javascript">//<![CDATA[content = "";content+="<table class='resultTable'>";content+="	<tr>";content+="		<th rowspan=2>구분</th>";content+="		<th rowspan=2>대상업체수(A)</th>";content+="		<th rowspan=2>제출업체수(B)</th>";content+="		<th rowspan=2>위반업체수(C)</th>";content+="		<th rowspan=2>미위반업체수(D)</th>";content+="		<th colspan=3>비율(%)</th>";content+="		<th colspan=11>업체별 위반행위수</th>";content+="	</tr>";content+="	<tr>";content+="		<th>B/A</th>";content+="		<th>C/B</th>";content+="		<th>D/B</th>";content+="		<th>1</th>";content+="		<th>2</th>";content+="		<th>3</th>";content+="		<th>4</th>";content+="		<th>5</th>";content+="		<th>6</th>";content+="		<th>7</th>";content+="		<th>8</th>";content+="		<th>9</th>";content+="		<th>10</th>";content+="		<th>10 초과</th>";content+="	</tr>";<%if( !tt.equals("start") ) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th rowspan=2>계</th>";content+="		<td rowspan=2><%=formater2.format(arrSum[1])%></td>";content+="		<td rowspan=2><%=formater2.format(arrSum[2])%></td>";content+="		<td rowspan=2><%=formater2.format(arrSum[3])%></td>";content+="		<td rowspan=2><%=formater2.format(arrSum[4])%></td>";content+="		<td rowspan=2><%if( arrSum[1]>0F ) {%><%=formater.format(arrSum[2] / arrSum[1] * 100)%><%} else {%>0.0<%}%>%</td>";content+="		<td rowspan=2><%if( arrSum[2]>0F ) {%><%=formater.format(arrSum[3] / arrSum[2] * 100)%><%} else {%>0.0<%}%>%</td>";content+="		<td rowspan=2><%if( arrSum[2]>0F ) {%><%=formater.format(arrSum[4] / arrSum[2] * 100)%><%} else {%>0.0<%}%>%</td>";	<%for(int x=5; x<=15; x++) {%>content+="		<td><%=formater2.format(arrSum[x])%></td>";	<%}%>content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";	<%for(int x=5; x<=15; x++) {		tmpSum = 0F;%>content+="		<td>";		<%for(int y=x; y<=11; y++) {			tmpSum = tmpSum + arrSum[y];		}%>		<%=formater2.format(tmpSum)%>content+="		</td>";	<%}%>content+="	</tr>";<%}%><%if( !tt.equals("start") ) {for(int k=1; k<=nLoop; k++) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th rowspan=2 style='text-align:left;'><%=arrData[k][1]%></th>";content+="		<td rowspan=2><%=formater2.format(Float.parseFloat(arrData[k][2]))%></td>";content+="		<td rowspan=2><%=formater2.format(Float.parseFloat(arrData[k][3]))%></td>";content+="		<td rowspan=2><%=formater2.format(Float.parseFloat(arrData[k][4]))%></td>";content+="		<td rowspan=2><%=formater2.format(Float.parseFloat(arrData[k][5]))%></td>";content+="		<td rowspan=2><%if( Float.parseFloat(arrData[k][2])>0F ) {%><%=formater.format(Float.parseFloat(arrData[k][3]) / Float.parseFloat(arrData[k][2]) * 100)%><%} else {%>0.0<%}%>%</td>";content+="		<td rowspan=2><%if( Float.parseFloat(arrData[k][3])>0F ) {%><%=formater.format(Float.parseFloat(arrData[k][4]) / Float.parseFloat(arrData[k][3]) * 100)%><%} else {%>0.0<%}%>%</td>";content+="		<td rowspan=2><%if( Float.parseFloat(arrData[k][3])>0F ) {%><%=formater.format(Float.parseFloat(arrData[k][5]) / Float.parseFloat(arrData[k][3]) * 100)%><%} else {%>0.0<%}%>%</td>";	<%for(int x=6; x<=16; x++) {%>content+="		<td><%=formater2.format(Float.parseFloat(arrData[k][x]))%></td>";	<%}%>content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";	<%for(int x=6; x<=16; x++) {		tmpSum = 0F;%>content+="		<td>";		<%for(int y=x; y<=11; y++) {			tmpSum = tmpSum + Float.parseFloat(arrData[k][y]);		}%>		<%=formater2.format(tmpSum)%>content+="		</td>";	<%}%>content+="	</tr>";<%}%><%}%>content+="</table>";top.document.getElementById("divResult").innerHTML = content;top.setNowProcessFalse();//]]</script>