<%@ page session="true" language="java" contentType="text/html; charset=euc-kr" pageEncoding="euc-kr"%><%/*** 프로젝트명	 : 하도급거래 서면실태조사 지원을 위한 개발용역 사업								   * 프로그램명	 : SOent_Submit_Total_proc.jsp																				   * 프로그램설명	: 수급사업자 > 제출현황 > 전체 제출현황   * 프로그램버전	: 3.1.1																				                        * 최초작성일자	: 2014년 09월 24일															                            * 작 성 이 력       :                                                                                                                           *=========================================================*	작성일자		작성자명				내용*=========================================================*	2014-09-24	정광식        최초작성*   2015-07-22   정광식		 조사제외대상 처리방법 변경 적용 (SP_FLD_03 필드에 제외사유)  *   2016-01-07   이용광        DB변경으로 인한 인코딩 변경*/%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="ftc.db.ConnectionResource2"%><%@ page import="java.text.DecimalFormat"%><%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%@ include file="/hado/wTools/inc/WB_I_chkMngSession.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String stt = StringUtil.checkNull(request.getParameter("tt")).trim();	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;	String sSQLs = "";	//int sStartYear = 2000;	int sStartYear = 2011;  	String oentgb = "";	String oentgbVal = "";    String typCnt = "";     String totalB = "";     String totalD = "";     String da = "";     String dc = "";     String ea = "";     String fa = "";     String d1 = "";     String d2 = "";     String d3 = "";     String d4 = "";     String d5 = "";     String d6 = "";     String d7 = "";     String d8 = "";     String d9 = "";         String result = "";	java.util.Calendar cal = java.util.Calendar.getInstance();	DecimalFormat formater = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0.00");	DecimalFormat formater2 = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0");/*-----------------------------------------------------------------------------------------------------*//*=================================== Record Selection Processing =====================================*/	String tmpYear = StringUtil.checkNull(request.getParameter("cyear")).trim();	if( !tmpYear.equals("") ) {		session.setAttribute("cyear", tmpYear);	} else {		session.setAttribute("cyear", st_Current_Year);	}	int currentYear = st_Current_Year_n;	currentYear = Integer.parseInt(session.getAttribute("cyear")+"");		try {		resource = new ConnectionResource();		conn = resource.getConnection();    		sSQLs =	  "SELECT     AAA.*                                                       \n";        sSQLs +=  "  	      ,to_char(TRUNC((TOTALD/TYP_CNT*100), 2), 'FM999990.00') DA  \n";        sSQLs +=  "  	      ,to_char(TRUNC((TOTALD/D7*100), 2), 'FM999990.00') DC       \n";        sSQLs +=  "  	      ,to_char(TRUNC((D8/TYP_CNT*100), 2), 'FM999990.00') EA      \n";        sSQLs +=  "  	      ,to_char(TRUNC((D9/TYP_CNT*100), 2), 'FM999990.00') FA      \n";        sSQLs +=  "        	FROM (                                                        \n";        sSQLs +=  "        	SELECT AA.* ,                                                 \n";        sSQLs +=  "        	       (D1 + D2 + D3 + D4) TOTALB,                            \n";        sSQLs +=  "        	       (AA.TYP_CNT - (D1 + D2 + D3 + D4)) D7,                 \n";        sSQLs +=  "        	       (D5 + D6) TOTALD,                                      \n";        sSQLs +=  "        	       (D1 + D2 + D3 + D4 + D5 + D6) D8,                      \n";        sSQLs +=  "        	       (AA.TYP_CNT - (D1 + D2 + D3 + D4)) - (D5 + D6)  D9     \n";        sSQLs +=  "        	FROM (                                                        \n";        sSQLs +=  "        	SELECT                                                        \n";        sSQLs +=  "        	    OENT_GB, COUNT(*) TYP_CNT, -- 총 대상업체(A)                  \n";        sSQLs +=  "        	    SUM(CASE WHEN Addr_Status='1' THEN 1 ELSE 0 END) d1,      \n";        sSQLs +=  "        	    SUM(CASE WHEN Addr_Status='2' THEN 1 ELSE 0 END) d2,      \n";        sSQLs +=  "        	    SUM(CASE WHEN Addr_Status='3' THEN 1 ELSE 0 END) d3,      \n";        sSQLs +=  "        	    SUM(CASE WHEN Addr_Status='4' THEN 1 ELSE 0 END) d4,      \n";        sSQLs +=  "        	    SUM(CASE WHEN Sent_Status='1' THEN                        \n";        sSQLs +=  "        	        CASE WHEN sp_fld_03 IS NULL THEN 1 ELSE 0 END         \n";        sSQLs +=  "        	    ELSE 0 END) d5,                                           \n";        sSQLs +=  "        	    SUM(CASE WHEN Sent_Status='1' THEN                        \n";        sSQLs +=  "        	        CASE WHEN sp_fld_03 IS NOT NULL THEN 1 ELSE 0 END     \n";        sSQLs +=  "        	    ELSE 0 END) d6                                            \n";        sSQLs +=  "        	FROM                                                          \n";        sSQLs +=  "        	    HADO_TB_SUBCON_2021                                       \n";        sSQLs +=  "        	    WHERE Sel_GB='1'                                          \n";        sSQLs +=  "        	        AND Current_Year='2021'                               \n";        sSQLs +=  "        	        AND SUBSTR(Mng_No,-7)<>'1234567'                      \n";        sSQLs +=  "        	        AND LENGTH(Mng_No) > 6                                \n";        sSQLs +=  "        	GROUP BY ROLLUP(OENT_GB)                                      \n";        sSQLs +=  "        	ORDER BY GROUPING(OENT_GB) desc, OENT_GB ) AA ) AAA           \n";        pstmt = conn.prepareStatement(sSQLs);		rs = pstmt.executeQuery();    		while( rs.next() ) {		    oentgb = rs.getString("OENT_GB")==null ? "":rs.getString("OENT_GB").trim();		    typCnt = rs.getString("TYP_CNT")==null ? "":rs.getString("TYP_CNT").trim();            totalB = rs.getString("TOTALB")==null ? "":rs.getString("TOTALB").trim();            totalD = rs.getString("TOTALD")==null ? "":rs.getString("TOTALD").trim();            da     = rs.getString("DA")==null ? "":rs.getString("DA").trim();                dc     = rs.getString("DC")==null ? "":rs.getString("DC").trim();                ea     = rs.getString("EA")==null ? "":rs.getString("EA").trim();                fa     = rs.getString("FA")==null ? "":rs.getString("FA").trim();                d1     = rs.getString("D1")==null ? "":rs.getString("D1").trim();                d2     = rs.getString("D2")==null ? "":rs.getString("D2").trim();                d3     = rs.getString("D3")==null ? "":rs.getString("D3").trim();                d4     = rs.getString("D4")==null ? "":rs.getString("D4").trim();                d5     = rs.getString("D5")==null ? "":rs.getString("D5").trim();                d6     = rs.getString("D6")==null ? "":rs.getString("D6").trim();                d7     = rs.getString("D7")==null ? "":rs.getString("D7").trim();                d8     = rs.getString("D8")==null ? "":rs.getString("D8").trim();                d9     = rs.getString("D9")==null ? "":rs.getString("D9").trim();                        if (oentgb.equals("1")) {                oentgbVal = "제조";            } else if (oentgb.equals("2")) {                oentgbVal = "건설";            } else if (oentgb.equals("3")) {                oentgbVal = "용역";            } else {                oentgbVal = "전체";            }                        result += "<tr>";            result += "<td>"+oentgbVal+"</td>";            result += "<td>"+typCnt.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+totalB.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d1.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d2.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d3.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d4.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d7.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+totalD.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d5.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d6.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d8.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+d9.replaceAll("\\B(?=(\\d{3})+(?!\\d))", ",")+"</td>";            result += "<td>"+da+"%</td>";            result += "<td>"+dc+"%</td>";            result += "<td>"+ea+"%</td>";            result += "<td>"+fa+"%</td>";            result +="</tr>";		} //  System.out.println("result ==> " + result);		rs.close();			}	catch(Exception e){		e.printStackTrace();	}	finally {		if ( rs != null ) try { rs.close(); } catch(Exception e) { }		if ( pstmt != null ) try { pstmt.close(); } catch(Exception e) { }		if ( conn != null ) try { conn.close(); } catch(Exception e) { }		if ( resource != null ) resource.release();	}/*=====================================================================================================*/%><meta charset="euc-kr"><script type="text/javascript">//<![CDATA[content = "";content+="<table id='divButton'>";content+="	<tr>";content+="		<td><%=cal.get(Calendar.YEAR)%>년<%=cal.get(Calendar.MONTH)+1%>월<%=cal.get(Calendar.DATE)%>일(현재)</td>";content+="	</tr>";content+="</table>";content+="<table class='resultTable'>";content+="	<tr>";content+="		<th rowspan=3 height=240px width=60px>업종별</th>";content+="		<th rowspan=3>총 대상업체(A)</th>";content+="		<th colspan=6>조사 대상 수급사업자</th>";content+="		<th colspan=3>정상제출</th>";content+="		<th rowspan=3>총제출(E=B+D)</th>";content+="		<th rowspan=3>미제출(F=C-D)</th>";content+="		<th colspan=4>비율</th>";content+="	</tr>";content+="	<tr>";content+="		<th colspan=5>조사 제외(B)</th>";content+="		<th rowspan=2>대상업체(C=A-B)</th>";content+="		<th rowspan=2>소계(D)</th>";content+="		<th rowspan=2>대상됨</th>";content+="		<th rowspan=2>대상제외</th>";content+="		<th rowspan=2>정상 제출 비율(D/A)</th>";content+="		<th rowspan=2>대상 업체 중 정상 제출 비율(D/C)</th>";content+="		<th rowspan=2>총 제출 비율(E/A)</th>";content+="		<th rowspan=2>미제출 비율(F/A)</th>";content+="	</tr>";content+="	<tr>";content+="		<th>소계</th>";content+="		<th>하도급거래없음</th>";content+="		<th>요건안됨(대기업,공기관,비영리단체,폐업)</th>";content+="		<th>중복리스트</th>";content+="		<th>소재불명</th>";content+="	</tr>";content+="<%=result%>"; content+="	</table>";top.document.getElementById("divResult").innerHTML = content;top.setNowProcessFalse();//]]</script><%@ include file="/hado/wTools/inc/WB_I_Function.jsp"%>