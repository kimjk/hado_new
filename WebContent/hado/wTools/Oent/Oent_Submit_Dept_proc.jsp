<%@ page session="true" language="java" contentType="text/html; charset=euc-kr" pageEncoding="euc-kr"%><%/*** 프로젝트명	: 하도급거래 서면실태조사 지원을 위한 개발용역 사업* 프로그램명	: Oent_Submit_Dept_proc.jsp* 프로그램설명	: 원사업자 > 제출현황 > 담당과별 제출현황* 프로그램버전	: 1.0.1* 최초작성일자	: 2009년 05월* 작 성 이 력       :*=========================================================*	작성일자		작성자명				내용*=========================================================*	2009-05-00	정광식       최초작성*   2011-10-18   정광식		웹관리툴 리뉴얼*	2016-01-08	민현근		DB변경으로 인한 인코딩 변경*/%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="ftc.db.ConnectionResource2"%><%@ page import="java.text.DecimalFormat"%><%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%@ include file="/hado/wTools/inc/WB_I_chkMngSession.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String stt = StringUtil.checkNull(request.getParameter("tt")).trim();	String comm = StringUtil.checkNull(request.getParameter("comm")).trim();	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;	String sCYear = st_Current_Year;	String sSQLs = "";	int i = 0;	int j = 0;	int m = 0;	String[] status_cd = new String[9];	String[] status_col = new String[9];	String[] type_cd = new String[38];	String[] type_row = new String[38];	String[] temp_col = new String[3];	Long[][] table_sum = new Long[30][12];	Long[] s_total = new Long[30];	Long[] e_total = new Long[12];	Long[] n_total = new Long[30];	Float[] rate1 = new Float[30]; 	Float[] rate2 = new Float[30];	Float[] rate3 = new Float[30];	Float[] rate4 = new Float[30];	float tot_rate1 = 0F;	float tot_rate2 = 0F;	float tot_rate3 = 0F;	float tot_rate4 = 0F;	long total = 0;	long tot_s_total = 0;	String ls = "";	int cnt = 0;	int col_cnt = 0;	int row_cnt = 0;	int e_tot_cnt = 0;	int sStartYear = 2009;	java.util.Calendar cal = java.util.Calendar.getInstance();	DecimalFormat formater = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0.00");/*-----------------------------------------------------------------------------------------------------*//*=================================== Record Selection Processing =====================================*/	String tmpYear = StringUtil.checkNull(request.getParameter("cyear")).trim();	if( !tmpYear.equals("") ) {		session.setAttribute("cyear", tmpYear);	} else {		session.setAttribute("cyear", st_Current_Year);	}	int currentYear = st_Current_Year_n;	currentYear = Integer.parseInt(session.getAttribute("cyear")+"");	int endCurrentYear = st_Current_Year_n;	try {		resource = new ConnectionResource();		conn = resource.getConnection();		sSQLs ="SELECT COMMON_CD, COMMON_NM \n";		sSQLs+="FROM COMMON_CD \n";		if(st_Current_Year_n == 2021) sSQLs+="WHERE COMMON_GB='011' \n";		else sSQLs+="WHERE COMMON_GB='005' \n";		sSQLs+="ORDER BY COMMON_CD \n";		pstmt = conn.prepareStatement(sSQLs);		rs = pstmt.executeQuery();		i = 1;		while( rs.next() ) {			status_col[i] = StringUtil.checkNull(rs.getString("COMMON_NM")).trim();			status_cd[i]  = StringUtil.checkNull(rs.getString("COMMON_CD")).trim();			i++;		}		rs.close();		if(st_Current_Year_n < 2021) i--;		if( !stt.equals("start") ) {			sSQLs ="SELECT Center_Name,Dept_Name,COUNT(Center_Name) TYP_CNT, \n";			for(int nx = 1; nx <= i-1; nx++) {				sSQLs+="	SUM(CASE WHEN COMP_STATUS = '" + status_cd[nx] + "' THEN \n";				sSQLs+="		CASE OENT_STATUS WHEN '1' THEN \n";				sSQLs+="			CASE WHEN (CASE WHEN ADDR_STATUS IS NULL THEN '0' ELSE '1' END) = '0' THEN 1 ELSE 0 END \n";				sSQLs+="		ELSE 0 END \n";				sSQLs+="	ELSE 0 END) D"  + status_cd[nx] + ", \n";			}			// 2009년 5월 25일 변경 (정광식) : 전송하였어도 소재불명등 기입된 내역 제외			sSQLs+="	SUM(CASE COMP_STATUS WHEN '1' THEN \n";			if(currentYear == 2021) {				sSQLs+="		CASE WHEN (SELECT TO_NUMBER(C) FROM HADO_TB_OENT_ANSWER_2021 WHERE MNG_NO = A.MNG_NO AND CURRENT_YEAR = A.CURRENT_YEAR AND OENT_GB = A.OENT_GB AND OENT_Q_CD = 5 AND OENT_Q_GB = 1) = 1 THEN \n";			} else {				sSQLs+="		CASE WHEN SUBCON_TYPE > '2' THEN \n";			}			sSQLs+="			CASE OENT_STATUS WHEN '1' THEN \n";			sSQLs+="				CASE WHEN (CASE WHEN ADDR_STATUS IS NULL THEN '0' ELSE '1' END) = '0' THEN 1 ELSE 0 END \n";			sSQLs+="			ELSE 0 END \n";			sSQLs+="		ELSE 0 END \n";			sSQLs+="	ELSE 0 END ) SUBCON, \n";			// 2009년 5월 25일 변경 (정광식) : 전송여부에 상관없이 소재불명등 누적			// 2009년 5월 29일 변경 (정광식) : 미전송 + 소재불명등 누적			sSQLs+="	SUM(CASE WHEN ADDR_STATUS IS NULL THEN 0 ELSE 1 END) MIS_ADDR \n";			// 20120611 - 2012년부터 원사업자 테이블 분리 변경 / 정광식			if( currentYear>=2012 ) {				sSQLs+="FROM HADO_VT_OENT_"+currentYear+" A \n";			} else {				sSQLs+="FROM HADO_VT_OENT_2010 \n";			}			sSQLs+="WHERE CURRENT_YEAR='" + currentYear + "' \n";			if(currentYear >= 2012) {				sSQLs+="	AND SUBSTR(MNG_NO,-7)<>'1234567' \n";				sSQLs+="	AND LENGTH(Mng_No)>7 \n";			} else if(currentYear == 2011) {				sSQLs+="	AND SUBSTR(MNG_NO,-7)<>'1234567' \n";				sSQLs+="	AND LENGTH(Mng_No)>8 \n";			} else {				sSQLs+="	AND SUBSTR(MNG_NO,-7)<>'1234567' \n";				sSQLs+="	AND LENGTH(Mng_No)>9 \n";			}			sSQLs+="GROUP BY Center_Name,Dept_Name \n";			sSQLs+="ORDER BY TYP_CNT DESC \n";			//System.out.println(sSQLs);			pstmt = conn.prepareStatement(sSQLs);			rs = pstmt.executeQuery();			m = 1;			e_total[1] = new Long(0);			while( rs.next() ) {				type_row[m] = "<b>["+rs.getString("Center_Name").trim().substring(0,2)+"]</b> "+rs.getString("Dept_Name").trim();;				s_total[m] = new Long(0);				table_sum[m][1] =  rs.getLong("TYP_CNT");				total += table_sum[m][1];				for(int n = 1; n <= i-1; n++) {					ls = "d" + status_cd[n];					cnt = n + 1;					table_sum[m][cnt] =  rs.getLong(ls);					s_total[m] = s_total[m] + table_sum[m][cnt];				}				rate1[m] = (s_total[m] / (float)table_sum[m][1]) * 100F;				e_total[1] = e_total[1] + s_total[m];				tot_s_total = tot_s_total + s_total[m];				table_sum[m][cnt+1] =  rs.getLong("SUBCON");				rate2[m] = (table_sum[m][cnt+1] / (float)table_sum[m][1]) * 100F;				table_sum[m][cnt+2] =  rs.getLong("MIS_ADDR");				table_sum[m][cnt+3] = table_sum[m][1] - s_total[m];				rate3[m] = (table_sum[m][cnt+2] / (float)table_sum[m][1]) * 100F;				rate4[m] = (table_sum[m][cnt+3] / (float)table_sum[m][1]) * 100F;				m++;			}			rs.close();			m--;		}	}	catch(Exception e){		e.printStackTrace();	}	finally {		if ( rs != null ) try{rs.close();}catch(Exception e){}		if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}		if ( conn != null ) try{conn.close();}catch(Exception e){}		if ( resource != null ) resource.release();	}	for(col_cnt = 2; col_cnt <= cnt+2; col_cnt++) {		e_total[col_cnt] = new Long(0);		for(row_cnt = 1; row_cnt <= m; row_cnt++) {			e_total[col_cnt] = e_total[col_cnt] + table_sum[row_cnt][col_cnt];		}	}	if( !stt.equals("start") ) {		e_total[cnt+3] = total - e_total[1];		if( total > 0) {			if(e_total[1] != null) {tot_rate1 = (e_total[1]/(float)total)*100F;}			if(e_total[9] != null) {tot_rate2 = (e_total[9]/(float)total)*100F;}			if(e_total[11] != null) {tot_rate3 = (e_total[11]/(float)total)*100F;}			if(e_total[10] != null) {tot_rate4 = (e_total[10]/(float)total)*100F;}		} else {			tot_rate1 = 0;			tot_rate2 = 0;			tot_rate3 = 0;			tot_rate4 = 0;		}	}%><meta charset="utf-8"><script type="text/javascript">//<![CDATA[content = "";content+="<table id='divButton'>";content+="	<tr>";content+="		<td><%=cal.get(Calendar.YEAR)%>년<%=cal.get(Calendar.MONTH)+1%>월<%=cal.get(Calendar.DATE)%>일(현재)</td>";content+="	</tr>";content+="</table>";content+="<table class='resultTable'>";content+="<table class='resultTable'>";content+="	<tr>";content+="		<th rowspan=3 height=240px width=80px>과별</th>";content+="		<th rowspan=3>조사대상업체(A)</th>";content+="		<th colspan=<%=i+1%>>제출</th>";content+="		<th colspan=2>미제출</th>";content+="		<th colspan=4>비율</th>";content+="	</tr>";content+="	<tr>";content+="		<th colspan=<%=i%>>회사영업상태</th>";content+="		<th rowspan= 2><font color=red>정상영업중 하도급거래없음(C)</font></th>";content+="		<th rowspan= 2>소계(D)</th>";content+="		<th rowspan= 2>소재불명등(E)</th>";content+="		<th rowspan= 2>B/A</th>";content+="		<th rowspan= 2>C/A</th>";content+="		<th rowspan= 2>D/A</th>";content+="		<th rowspan= 2>E/A</th>";content+="	</tr>";content+="	<tr>";content+="		<th>소계(B)</th>";<%for(int x=1 ; x <= i-1; x++) {%>content+="		<th height='60px'><%=status_col[x]%></th>";<%}%>content+="	</tr>";<%if( !stt.equals("start") ) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th>계</th>";content+="		<td><%=StringUtil.formatNumber(total)%></td>";	<%for (e_tot_cnt =1; e_tot_cnt <= col_cnt-2; e_tot_cnt++) {%>content+="		<td align=right><%if (e_tot_cnt == 9 ) {%><font color=red><%}%><%=StringUtil.formatNumber(e_total[e_tot_cnt])%><%if(e_tot_cnt == 9) {%></font><%}%></td>";	<%}%>content+="		<td align=right><%=StringUtil.formatNumber(e_total[e_tot_cnt+1])%></td>";content+="		<td right><%=StringUtil.formatNumber(e_total[e_tot_cnt])%></td>";content+="		<td><%=formater.format(tot_rate1)%>%</td>";content+="		<td><%=formater.format(tot_rate2)%>%</td>";content+="		<td><%=formater.format(tot_rate3)%>%</td>";content+="		<td><%=formater.format(tot_rate4)%>%</td>";content+="	</tr>";	<%for(int y=1; y <= m; y++) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th><%=type_row[y]%></th>";content+="		<td align=right><%=StringUtil.formatNumber(table_sum[y][1])%></td>";content+="		<td align=right><%=StringUtil.formatNumber(s_total[y])%></td>";	<%for(int z=2; z<= i+1;z++) {%>content+="		<td align=right><%if(z == 9 ) {%><font color=red><%}%><%=StringUtil.formatNumber(table_sum[y][z])%><%if(z == 9) {%></font><%}%></td>";	<%}%>content+="		<td align=right><%=StringUtil.formatNumber(table_sum[y][i+3])%></td>";content+="		<td align=right><%=StringUtil.formatNumber(table_sum[y][i+2])%></td>";content+="		<td align=right><%=formater.format(rate1[y])%>%</td>";content+="		<td align=right><%=formater.format(rate2[y])%>%</td>";content+="		<td align=right><%=formater.format(rate4[y])%>%</td>";content+="		<td align=right><%=formater.format(rate3[y])%>%</td>";content+="	</tr>";	<%}%><%}%>content+="</table>";top.document.getElementById("divResult").innerHTML = content;top.setNowProcessFalse();//]]</script><%@ include file="/hado/wTools/inc/WB_I_Function.jsp"%>