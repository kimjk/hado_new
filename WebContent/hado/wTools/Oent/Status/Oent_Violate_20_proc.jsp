<%@ page session="true" language="java" contentType="text/html; charset=euc-kr" pageEncoding="euc-kr"%><%/*** 프로젝트명	: 하도급거래 서면실태조사 지원을 위한 개발용역 사업* 프로그램명	: Oent_Violate_20_proc.jsp* 프로그램설명	: 원사업자 > 조사결과분석 > 수급사업자 수 현황* 프로그램버전	: 1.0.1* 최초작성일자	: 2014년 09월 14일* 작 성 이 력       :*=========================================================*	작성일자		작성자명				내용*=========================================================*	2014-09-14	정광식       최초작성*	2015-06-10	강슬기       페이지 최신화(주석, 불필요한 코드 제거, 오래된 코드 수정)*	2016-01-08	민현근		DB변경으로 인한 인코딩 변경*/%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="java.text.DecimalFormat"%><%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%@ include file="/hado/wTools/inc/WB_I_chkMngSession.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String stt = request.getParameter("tt")==null ? "":request.getParameter("tt").trim();	String comm = request.getParameter("comm")==null ? "":request.getParameter("comm").trim();	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;	String sCYear = st_Current_Year;	String sSQLs = "";	String tmpStr = "";	String[][] arrData = new String[51][23];	float[] arrSum = new float[21];	int nLoop = 1;	int sStartYear = 2000;	java.util.Calendar cal = java.util.Calendar.getInstance();	DecimalFormat formater = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0.0");	DecimalFormat formater2 = new java.text.DecimalFormat("###,###,###,###,###,###,###,##0");/*-----------------------------------------------------------------------------------------------------*//*=================================== Record Selection Processing =====================================*/	String tmpYear = request.getParameter("cyear")==null ? "":request.getParameter("cyear").trim();	String sTradeST=request.getParameter("tradest")==null ? "":request.getParameter("tradest").trim();	if( !tmpYear.equals("") ) {		session.setAttribute("cyear", tmpYear);	} else {		session.setAttribute("cyear", st_Current_Year);	}	if( stt.equals("start") ) {		session.setAttribute("wgb", "1");	}	if( comm.equals("search") ) {		session.setAttribute("wgb", request.getParameter("wgb")==null ? "":request.getParameter("wgb").trim());	}	// 합계배열 초기화	for(int i=1; i <=20; i++) {		arrSum[i] = 0F; 		}	int currentYear = st_Current_Year_n;	currentYear = Integer.parseInt(session.getAttribute("cyear")+"");	int endCurrentYear = st_Current_Year_n;	// view table name	String currentOent = currentYear>=2012 ? "HADO_TB_Oent_"+tmpYear : "HADO_TB_Oent";	String currentAnswer = currentYear>=2012 ? "HADO_TB_Oent_Answer_"+tmpYear : "HADO_TB_Oent_Answer";	try {		resource = new ConnectionResource();		conn = resource.getConnection();		if( !session.getAttribute("wgb").equals("") ) {			sSQLs="SELECT Oent_Type, B.Common_NM Common_NM, \n";			sSQLs+="Field01, Field02, Field03, Field04, Field05, Field06, Field07, Field08, Field09, Field10, \n";			sSQLs+="Field11, Field12, Field13, Field14, Field15, Field16, Field17, Field18, Field19 FROM ( \n";			sSQLs+="	SELECT C.Oent_Type Oent_Type, \n";		} else {			sSQLs="SELECT Oent_Type, '' Common_NM, \n";			sSQLs+="Field01, Field02, Field03, Field04, Field05, Field06, Field07, Field08, Field09, Field10, \n";			sSQLs+="Field11, Field12, Field13, Field14, Field15, Field16, Field17, Field18, Field19 FROM ( \n";			sSQLs+="	SELECT C.Oent_GB Oent_Type, \n";		}		sSQLs+="	COUNT(C.Mng_No) Field01, \n";		sSQLs+="	SUM(NVL(Cnt,0)) Field02, \n";		sSQLs+="	ROUND(SUM(NVL(Cnt,0))/COUNT(C.Mng_No),0) Field03, \n";		sSQLs+="	SUM(CASE WHEN NVL(Cnt,0) BETWEEN 0 AND 100 THEN 1 ELSE 0 END) Field04, \n";		sSQLs+="	SUM(CASE WHEN Cnt>100 THEN 1 ELSE 0 END) Field05, \n";		sSQLs+="	SUM(CASE WHEN NVL(Cnt,0)=0 THEN 1 ELSE 0 END) Field06, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 1 AND 5 THEN 1 ELSE 0 END) Field07, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 6 AND 10 THEN 1 ELSE 0 END) Field08, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 11 AND 50 THEN 1 ELSE 0 END) Field09, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 51 AND 100 THEN 1 ELSE 0 END) Field10, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 101 AND 150 THEN 1 ELSE 0 END) Field11, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 151 AND 200 THEN 1 ELSE 0 END) Field12, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 201 AND 250 THEN 1 ELSE 0 END) Field13, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 251 AND 300 THEN 1 ELSE 0 END) Field14, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 301 AND 350 THEN 1 ELSE 0 END) Field15, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 351 AND 400 THEN 1 ELSE 0 END) Field16, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 401 AND 450 THEN 1 ELSE 0 END) Field17, \n";		sSQLs+="	SUM(CASE WHEN Cnt BETWEEN 451 AND 500 THEN 1 ELSE 0 END) Field18, \n";		sSQLs+="	SUM(CASE WHEN Cnt>500 THEN 1 ELSE 0 END) Field19 FROM ( \n";		sSQLs+="		SELECT Mng_No, Current_Year, Oent_GB, Oent_Type, \n";		sSQLs+="		Comp_Status, Oent_Status, Subcon_Type, Addr_Status, \n";		sSQLs+="		NVL(CASE Subcon_Type WHEN '1' THEN '0' ELSE \n";        sSQLs+="			CASE WHEN SP_FLD_01 IS NULL OR SP_FLD_01='NULL' THEN '4' ELSE SP_FLD_01 END \n";        sSQLs+="		END, 0) TradeST FROM "+currentOent+" \n";		sSQLs+="	) C LEFT JOIN ( \n";		sSQLs+="		SELECT COUNT(Mng_No) cnt, Mng_No, Current_Year, Oent_GB FROM HADO_TB_SUBCON_"+currentYear+" \n";		sSQLs+="		GROUP BY Mng_No, Current_Year, Oent_GB \n";		sSQLs+="	) D ON C.Mng_No=D.Mng_No AND C.Current_Year=D.Current_Year AND C.Oent_GB=D.Oent_GB \n";		sSQLs+="	WHERE C.Current_Year='"+currentYear+"' \n";		sSQLs+="		AND Comp_Status='1' \n";		sSQLs+="		AND Oent_Status='1' \n";		sSQLs+="		AND Subcon_Type<='2' \n";		sSQLs+="		AND Addr_Status IS NULL \n";		if( currentYear>=2014 ) {			sSQLs+="	AND LENGTH(C.Mng_No)>6 \n";		} else {			sSQLs+="	AND LENGTH(C.Mng_No)>4 \n";			sSQLs+="	AND SUBSTR(C.Mng_No,-7)<>'1234567' \n";		}		if( !sTradeST.equals("") ) {				sSQLs+="		AND TradeST='"+sTradeST+"' \n";		}		if( !session.getAttribute("wgb").equals("") ) {			sSQLs+="		AND C.Oent_GB='"+session.getAttribute("wgb")+"' \n";			sSQLs+="	GROUP BY C.Oent_Type \n";		} else {			sSQLs+="	GROUP BY C.Oent_GB \n";		}		sSQLs+=") A \n";		if( !session.getAttribute("wgb").equals("") ) {			sSQLs+="LEFT JOIN ( \n";			sSQLs+="	SELECT Common_CD, Common_NM, COMMON_GB \n";			sSQLs+="	FROM COMMON_CD \n";			sSQLs+="	WHERE Addon_GB='"+session.getAttribute("wgb")+"' \n";			sSQLs+=") B ON Replace(A.Oent_Type,'i','I')=B.COMMON_CD  \n";			if( currentYear>=2012 ) 			sSQLs+="AND COMMON_GB='010' \n";			//sSQLs+="GROUP BY A.Oent_Type, B.Common_NM \n";			sSQLs+="ORDER BY A.Oent_Type \n";		} else {			//sSQLs+="GROUP BY Oent_Type \n";			sSQLs+="ORDER BY Oent_Type \n";		}		System.out.println(sSQLs);		pstmt = conn.prepareStatement(sSQLs);		rs = pstmt.executeQuery();		nLoop = 1;		while( rs.next() ) {			arrData[nLoop][21] = rs.getString("Oent_Type");			arrData[nLoop][22] = rs.getString("Common_NM")==null ? "":rs.getString("Common_NM").trim();			arrData[nLoop][2] = rs.getString("Field01");			arrData[nLoop][3] = rs.getString("Field02");			arrData[nLoop][4] = rs.getString("Field03");			arrData[nLoop][5] = rs.getString("Field04");			arrData[nLoop][6] = rs.getString("Field05");			arrData[nLoop][7] = rs.getString("Field06");			arrData[nLoop][8] = rs.getString("Field07");			arrData[nLoop][9] = rs.getString("Field08");			arrData[nLoop][10] = rs.getString("Field09");			arrData[nLoop][11] = rs.getString("Field10");			arrData[nLoop][12] = rs.getString("Field11");			arrData[nLoop][13] = rs.getString("Field12");			arrData[nLoop][14] = rs.getString("Field13");			arrData[nLoop][15] = rs.getString("Field14");			arrData[nLoop][16] = rs.getString("Field15");			arrData[nLoop][17] = rs.getString("Field16");			arrData[nLoop][18] = rs.getString("Field17");			arrData[nLoop][19] = rs.getString("Field18");			arrData[nLoop][20] = rs.getString("Field19");			nLoop++;		}		rs.close();		nLoop--;		for(int i=1; i<=nLoop; i++) {			for(int j=2; j<=20; j++) {				if( !arrData[i][j].equals("") ) {					arrSum[j] = arrSum[j] + Float.parseFloat(arrData[i][j]);				} else {					arrData[i][j] = "0";				}			}		}	} catch(Exception e) {		e.printStackTrace();	} finally {		if (rs != null)		try{rs.close();}	catch(Exception e) {}		if (pstmt != null)	try{pstmt.close();}	catch(Exception e) {}		if (conn != null)	try{conn.close();}	catch(Exception e) {}		if (resource != null) resource.release();}/*=====================================================================================================*/%><meta charset="euc-kr"><script type="text/javascript">//<![CDATA[content="";content+="<table class='resultTable'>";content+="	<tr>";content+="		<th rowspan='2'>구분</th>";content+="		<th rowspan='2'>정상영업중 하도급거래업체수</th>";content+="		<th colspan='5'>수급사업자수</th>";content+="		<th colspan='14'>원사업자별 수급사업자 수 분포</th>";content+="	</tr>";content+="	<tr>";content+="		<th>총수</th>";content+="		<th>평균</th>";content+="		<th>계</th>";content+="		<th>100<br/>이하</th>";content+="		<th>101<br/>이상</th>";content+="		<th>0</th>";content+="		<th>1~<br/>5</th>";content+="		<th>6~<br/>10</th>";content+="		<th>11~<br/>50</th>";content+="		<th>51~<br/>100</th>";content+="		<th>101~<br/>150</th>";content+="		<th>151~<br/>200</th>";content+="		<th>201~<br/>250</th>";content+="		<th>251~<br/>300</th>";content+="		<th>301~<br/>350</th>";content+="		<th>351~<br/>400</th>";content+="		<th>401~<br/>450</th>";content+="		<th>451~<br/>500</th>";content+="		<th>501<br/>이상</th>";content+="	</tr>";<%if( !stt.equals("start") ) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th rowspan='2'>계</th>";content+="		<td rowspan='2'><%=formater2.format(arrSum[2])%></td>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'><%=formater2.format(arrSum[2])%></td>";	<%for(int j = 5; j<=20; j++) { %>content+="		<td><%=formater2.format(arrSum[j])%></td>";	<%}%>content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";	<%for(int j = 5; j<=20; j++) { %>content+="		<td><%=formater.format(arrSum[j]/arrSum[2]*100F)%>%</td>";	<%}%>content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";content+="		<th rowspan='2'>수급사업자수</th>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'><%=formater2.format(arrSum[3])%></td>";content+="		<td rowspan='2'><%=formater.format(arrSum[3]/arrSum[2])%></td>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'>&nbsp;</td>";content+="		<td rowspan='2'>&nbsp;</td>";	<%for(int j = 8; j<=20; j++) { %>content+="		<td><%=formater2.format(arrSum[j])%></td>";	<%}%>content+="	</tr>";content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";	<%for(int j = 8; j<=20; j++) { %>content+="		<td><%=formater.format(arrSum[j]/arrSum[3]*100F)%>%</td>";	<%}%>content+="	</tr>";<%}%><%if( !stt.equals("start") ) {%>	<%for(int ni=1; ni<=nLoop; ni++) {%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";		<%if( !session.getAttribute("wgb").equals("") ) {%>	content+="		<th rowspan='2'><%=arrData[ni][21]%> (<%=arrData[ni][22]%>)</th>";		<%} else {%>						<%if( arrData[ni][21].equals("1") ) {%>		content+="		<th rowspan='2'>제조</th>";			<%} else if( arrData[ni][21].equals("2") ) {%>content+="		<th rowspan='2'>건설</th>";			<%} else if( arrData[ni][21].equals("3") ) {%>								content+="		<th rowspan='2'>용역</th>";			<%}%>		<%}%>		<%for(int j = 2; j<=3; j++) { %>content+="		<td rowspan='2'><%=formater2.format(Float.parseFloat(arrData[ni][j]))%></td>";		<%}%>content+="		<td rowspan='2'><%=formater.format(Float.parseFloat(arrData[ni][3])/Float.parseFloat(arrData[ni][2]))%></td>";content+="		<td rowspan='2'><%=formater2.format(Float.parseFloat(arrData[ni][2]))%></td>";		<%for(int j = 5; j<=20; j++) { %>content+="		<td><%=formater2.format(Float.parseFloat(arrData[ni][j]))%></td>";		<%}%>content+="	<tr onMouseOver='tbRow_Over(this)' onMouseOut='tbRow_Out(this)'>";		<%for(int j = 5; j<=20; j++) { %>content+="		<td><%=formater.format(Float.parseFloat(arrData[ni][j])/Float.parseFloat(arrData[ni][2])*100F)%>%</td>";		<%}%>content+="	</tr>";	<%}%><%} else {%>content+="	<tr>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="		<td>&nbsp;</td>";content+="	</tr>";<%}%>content+="</table>";top.document.getElementById("divResult").innerHTML=content;top.setNowProcessFalse();//]]</script><%@ include file="/hado/wTools/inc/WB_I_Function.jsp"%>