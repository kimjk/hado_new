<%@ page session="true" language="java" contentType="text/html; charset=euc-kr" pageEncoding="euc-kr"%><%/*** 프로젝트명	: 하도급거래 서면실태조사 지원을 위한 개발용역 사업* 프로그램명	: Oent_Query.jsp* 프로그램설명	: 원사업자 정보 수정 프로세스* 프로그램버전	: 1.0.1* 최초작성일자	: 2009년 05월* 작 성 이 력       :*=========================================================*	작성일자		작성자명				내용*=========================================================*	2009-05-00	정광식       최초작성*	2011-10-18	정광식		웹관리툴 리뉴얼*	2015-12-30	정광식		DB변경으로 인한 인코딩 변경*/%>
<%@ page import="java.io.*"%><%@ page import="java.sql.*"%><%@ page import="java.util.*"%><%@ page import="ftc.util.*"%><%@ page import="ftc.db.ConnectionResource"%><%@ page import="ftc.db.ConnectionResource2"%>
<%@ include file="/hado/wTools/inc/WB_I_Global.jsp"%><%/*---------------------------------------- Variable Difinition ----------------------------------------*/	String sCmd = request.getParameter("sql")==null ? "":request.getParameter("sql").trim();	String sLoc = request.getParameter("loc")==null ? "":request.getParameter("loc").trim();	String sMsg = request.getParameter("msg")==null ? "":request.getParameter("msg").trim();	String sMngNo = request.getParameter("no")==null ? "":request.getParameter("no").trim();	String sCYear = request.getParameter("yyyy")==null ? "":request.getParameter("yyyy").trim();	String sOentGB = request.getParameter("gb")==null ? "":request.getParameter("gb").trim();	String sSentNo = request.getParameter("sno")==null ? "":request.getParameter("sno").trim();	String sQ_CD = request.getParameter("mqcd")==null ? "":request.getParameter("mqcd").trim();	String sQ_GB = request.getParameter("mqgb")==null ? "":request.getParameter("mqgb").trim();	String sProc = request.getParameter("proc")==null ? "":request.getParameter("proc").trim();
	ConnectionResource resource = null;	Connection conn = null;	PreparedStatement pstmt = null;	ResultSet rs = null;
	String sSQLs = "";	String sReturnURL = "/hado/hado/index2.jsp";	String sTableName1 = "HADO_TB_Oent";	String sTableName2 = "HADO_TB_Oent_Answer";	String sTableName3 = "HADO_TB_REC_PAY";	String sTableName4 = "HADO_TB_OENT_CASH_PAYTYPE";/*-----------------------------------------------------------------------------------------------------*/
/*=================================== Record Selection Processing =====================================*/	if( sCYear.equals("2012") ) {		sTableName1 = "HADO_TB_Oent_2012";		sTableName2 = "HADO_TB_Oent_Answer_2012";		sTableName3 = "HADO_TB_REC_PAY_2012";		sTableName4 = "HADO_TB_OENT_CASH_PAYTYPE_2012";	} else if( sCYear.equals("2013") ) {
		sTableName1 = "HADO_TB_Oent_2013";
		sTableName2 = "HADO_TB_Oent_Answer_2013";
		sTableName3 = "HADO_TB_REC_PAY_2013";
		sTableName4 = "HADO_TB_OENT_CASH_PAYTYPE_2013";
	} else if( sCYear.equals("2014") ) {
		sTableName1 = "HADO_TB_Oent_2014";
		sTableName2 = "HADO_TB_Oent_Answer_2014";
		sTableName3 = "HADO_TB_REC_PAY_2014";
		//sTableName4 = "HADO_TB_OENT_CASH_PAYTYPE_2014";
	} else if( sCYear.equals("2015") ) {
		sTableName1 = "HADO_TB_Oent_2015";
		sTableName2 = "HADO_TB_Oent_Answer_2015";
		sTableName3 = "HADO_TB_REC_PAY_2015";
	} else if( sCYear.equals("2016") ) {		sTableName1 = "HADO_TB_Oent_2016";		sTableName2 = "HADO_TB_Oent_Answer_2016";		sTableName3 = "HADO_TB_REC_PAY_2016";	} else if( sCYear.equals("2017") ) {		sTableName1 = "HADO_TB_Oent_2017";		sTableName2 = "HADO_TB_Oent_Answer_2017";		sTableName3 = "HADO_TB_REC_PAY_2017";	} else if( sCYear.equals("2018") ) {		sTableName1 = "HADO_TB_Oent_2018";		sTableName2 = "HADO_TB_Oent_Answer_2018";		sTableName3 = "HADO_TB_REC_PAY_2018";	}

	if( sCmd != null && sCmd.equals("edit") ) {		if(sMngNo != null && sCYear != null && sOentGB != null && (!sMngNo.equals("")) && (!sCYear.equals("")) && (!sOentGB.equals("")) ) {
			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				sSQLs = "UPDATE "+sTableName1+" SET OENT_NAME = '" + request.getParameter("oname").trim().replaceAll("'","''") + "'";				if(request.getParameter("mtype2") != null) {					sSQLs += ", OENT_TYPE = '" + request.getParameter("mtype2").trim() + "'";				}				if(request.getParameter("ocaptine") != null) {					sSQLs += ", OENT_CAPTINE = '" + request.getParameter("ocaptine").trim().replaceAll("'","''") + "'";				} else {					sSQLs += ", OENT_CAPTINE = ''";				}				//if(request.getParameter("rpost1") != null && request.getParameter("rpost2") != null) {				if(request.getParameter("rpost") != null) {					sSQLs += ", zip_code='"+request.getParameter("rpost").trim()+"'";				} else {					sSQLs += ", zip_code=''";				}				if(request.getParameter("raddr") != null) {					sSQLs += ", oent_address='"+request.getParameter("raddr").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_address=''";				}				if(request.getParameter("otel") != null) {					sSQLs += ", oent_tel='"+request.getParameter("otel").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_tel=''";				}				if(request.getParameter("ofax") != null) {					sSQLs += ", oent_fax='"+request.getParameter("ofax").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_fax=''";				}				if(request.getParameter("osale01") != null && (!request.getParameter("osale01").equals(""))) {					sSQLs += ", oent_sale01="+request.getParameter("osale01").trim().replaceAll(",","");				} else {					sSQLs += ", oent_sale01=0";				}				if(request.getParameter("osale02") != null && (!request.getParameter("osale02").equals(""))) {					sSQLs += ", oent_sale02="+request.getParameter("osale02").trim().replaceAll(",","");				} else {					sSQLs += ", oent_sale02=0";				}				if(request.getParameter("oconamt") != null && (!request.getParameter("oconamt").equals(""))) {					sSQLs += ", oent_con_amt="+request.getParameter("oconamt").trim().replaceAll(",","");				} else {					sSQLs += ", oent_con_amt=0";				}				if(request.getParameter("oempcnt") != null && (!request.getParameter("oempcnt").equals(""))) {					sSQLs += ", oent_emp_cnt="+request.getParameter("oempcnt").trim().replaceAll(",","");				} else {					sSQLs += ", oent_emp_cnt=0";				}				if(request.getParameter("ocogb") != null) {					sSQLs += ", oent_co_gb='"+request.getParameter("ocogb").trim()+"'";				} else {					sSQLs += ", oent_co_gb=''";				}				if(request.getParameter("ocono") != null) {					sSQLs += ", oent_co_no='"+request.getParameter("ocono").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_co_no=''";				}				if(request.getParameter("ono") != null) {					sSQLs += ", oent_sa_no='"+request.getParameter("ono").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_sa_no=''";				}				if(request.getParameter("assignmail") != null) {					sSQLs += ", assign_mail='"+request.getParameter("assignmail").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", assign_mail=''";				}				if(request.getParameter("w") != null) {					sSQLs += ", writer_name='"+request.getParameter("w").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", writer_name=''";				}				if(request.getParameter("worg") != null) {					sSQLs += ", writer_org='"+request.getParameter("worg").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", writer_org=''";				}				if(request.getParameter("wjikwi") != null) {					sSQLs += ", writer_jikwi='"+request.getParameter("wjikwi").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", writer_jikwi=''";				}				if(request.getParameter("wtel") != null) {					sSQLs += ", writer_tel='"+request.getParameter("wtel").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", writer_tel=''";				}				if(request.getParameter("wfax") != null) {					sSQLs += ", writer_fax='"+request.getParameter("wfax").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", writer_fax=''";				}				if(request.getParameter("returngb") != null) {					sSQLs += ", return_gb='"+request.getParameter("returngb").trim()+"'";				} else {					sSQLs += ", return_gb=''";				}				if(request.getParameter("resend") != null) {					sSQLs += ", re_send='"+request.getParameter("resend").trim()+"'";				} else {					sSQLs += ", re_send=''";				}				if(request.getParameter("compstatus") != null) {					sSQLs += ", comp_status='"+request.getParameter("compstatus").trim()+"'";				} else {					sSQLs += ", comp_status=''";				}				if(request.getParameter("subcontype") != null) {					sSQLs += ", subcon_type='"+request.getParameter("subcontype").trim()+"'";				} else {					sSQLs += ", subcon_type=''";				}				if(request.getParameter("ostatus") != null) {					sSQLs += ", oent_status='"+request.getParameter("ostatus").trim()+"'";				} else {					sSQLs += ", oent_status=''";				}				if(request.getParameter("astatus") != null) {					sSQLs += ", addr_status='"+request.getParameter("astatus").trim()+"'";				} else {					sSQLs += ", addr_status=''";				}				if(request.getParameter("oent_remake") != null) {					sSQLs += ", oent_remake='"+request.getParameter("oent_remake").trim().replaceAll("'","''")+"'";				} else {					sSQLs += ", oent_remake=''";				}				sSQLs += " where mng_no='"+sMngNo+"' and current_year='"+sCYear+"' and oent_gb='"+sOentGB+"'";
				//System.out.println(sSQLs);
				pstmt = conn.prepareStatement(sSQLs);				int updateCNT = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
			sReturnURL	=  "Oent_View.jsp?no="+sMngNo+"&yyyy="+sCYear+"&gb="+sOentGB;		}	}
	if( sCmd != null && sCmd.equals("answerdel") ) {		if(sMngNo != null && sCYear != null && sOentGB != null && sQ_CD != null & sQ_GB != null && (!sMngNo.equals("")) && (!sCYear.equals("")) && (!sOentGB.equals("")) && (!sQ_CD.equals("")) && (!sQ_GB.equals("")) ) {			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				sSQLs = "DELETE FROM "+sTableName2+" WHERE Mng_No = '" + sMngNo + "' " +						"AND Current_Year = '" + sCYear + "' " +						"AND Oent_gb = '" + sOentGB + "' " +						"AND Oent_Q_CD = " + sQ_CD + " AND Oent_Q_GB = " + sQ_GB;
				pstmt = conn.prepareStatement(sSQLs);				int updateCNT = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}		}		sReturnURL	=  "delanswer.jsp?no="+sMngNo+"&yyyy="+sCYear+"&gb="+sOentGB;	}
	if( sCmd != null && sCmd.equals("answerinit") ) {		if(sMngNo != null && sCYear != null && sOentGB != null && (!sMngNo.equals("")) && (!sCYear.equals("")) && (!sOentGB.equals("")) ) {			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				// 하도급거래상황				sSQLs ="DELETE FROM "+sTableName2+" \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT1 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}						try {				resource = new ConnectionResource();				conn = resource.getConnection();				
				// 본사 및 사업소현황				sSQLs ="DELETE FROM HADO_TB_OENT_HD_BR \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);				int updateCNT2 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
			try {				resource = new ConnectionResource();				conn = resource.getConnection();				
				// 하도급대금 내역				sSQLs ="DELETE FROM "+sTableName3+" \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT3 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
			try {				resource = new ConnectionResource();				conn = resource.getConnection();				
				// 현금성 결제내역 1				sSQLs ="DELETE FROM HADO_TB_OENT_CASH_DAYTERM \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT4 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
							try {				resource = new ConnectionResource();				conn = resource.getConnection();				
				// 현금성 결제내역 2				sSQLs ="DELETE FROM "+sTableName4+" \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT5 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}				
			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				// 수급사업자 업로드 파일				sSQLs ="DELETE FROM HADO_TB_OENT_SUBCON_FILE \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT6 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}						try {				resource = new ConnectionResource();				conn = resource.getConnection();				// 수급사업자 업로드 파일 처리				sSQLs ="DELETE FROM HADO_TB_OENT_SUBCON_FILEPROC \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);				int updateCNT6 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				// 수급사업자명부				sSQLs ="DELETE FROM HADO_TB_SUBCON_"+sCYear+" \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT7 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}
			try {				resource = new ConnectionResource();				conn = resource.getConnection();
				// 2010.5.25 류지호 초기화시 저장버튼이 안보이는 문제로 oent_status=null 추가				sSQLs ="UPDATE "+sTableName1+" \n";				sSQLs+="SET Oent_Status=NULL \n";				sSQLs+="WHERE Mng_No=? \n";				sSQLs+="	AND Current_Year=? \n";				sSQLs+="	AND Oent_GB=? \n";
				pstmt = conn.prepareStatement(sSQLs);				pstmt.setString(1,sMngNo);				pstmt.setString(2,sCYear);				pstmt.setString(3,sOentGB);
				int updateCNT8 = pstmt.executeUpdate();			} catch(Exception e){				e.printStackTrace();			} finally {				if ( rs != null ) try{rs.close();}catch(Exception e){}				if ( pstmt != null ) try{pstmt.close();}catch(Exception e){}				if ( conn != null ) try{conn.close();}catch(Exception e){}				if ( resource != null ) resource.release();			}		}	}/*=====================================================================================================*/%><html><head>	<title></title>	<meta charset="euc-kr">	<script type="text/javascript">	//<![CDATA[		<%if( sCmd != null && sCmd.equals("edit") ) {%>		alert("원사업자 정보를 수정하였습니다.");		top.view('<%=sMngNo%>','<%=sCYear%>','<%=sOentGB%>');		<%}%>			<%if( sCmd != null && sCmd.equals("answerinit") ) {%>		alert("원사업자 응답내역 초기화를 완료 하였습니다");		top.setNowProcessFalse();		<%}%>	//]]	</script></head><body></body></html>
